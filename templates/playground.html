<!DOCTYPE html> <html> <head> <title>Go游乐场</title> <link rel="stylesheet" href="/static/css/play.css"> <script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.0.3/jquery.min.js"></script> </head> <body> <div id="banner"> <div id="head">Go游乐场</div>
			<div id="controls">
				<input type="button" value="运行" id="run">
				<input type="button" value="格式化" id="fmt">
				<div id="importsBox">
					<label>
						<input type="checkbox" id="imports" checked="checked">导入</label>
				</div> <input type="button" value="分享" id="share">
				<input type="text" id="shareURL" style="display:none">
			</div>
		</div>
		<div id="wrap">
			<div class="linedtextarea">
				<textarea spellcheck="false" id="code">package main
import "fmt"
func main(){
	fmt.Println("这个游乐场可以用于重现和分享Go代码.")
}</textarea>
			</div>
		</div>
		<div id="output">
			<pre id="response"></pre>
		</div>
	</body>
	<script type="text/javascript">
	// console 重定向
	(function(){
		var oldLog = console.log;

		console.log = function(message){
			$("#response").css("color","black");
			$("#response").text(message);
			oldLog.apply(console,arguments);
		};
	})();

	var socket = new WebSocket("ws://localhost:8888/playsocket");
	socket.onopen = function(event){

		// 分享代码
		$( "#share" ).click(function(){
			$("#shareURL").css("display","inline-block");
			var id = "{{.CodeId}}";
			if(id!==""){
				var url = "{{.Host}}"+"/play/"+id;
				$("#shareURL").val(url);
				$("#shareURL").select();
			}else{
				//　提交新的代码.
				var code = $("#code").text();
				var cmd = {
					Command:"share",
					Content:code,
				}	
				socket.send(JSON.stringify(cmd));
			}
		});

		// 运行代码
		$( "#run" ).click(function(){
			var code  = $("#code").val();
			var cmd = {
				Command:"run",
				Content:code,
			}
			socket.send(JSON.stringify(cmd));
		});
		window.onunload = function(){
			var cmd = {
				Command:"close",
			}
			socket.send(JSON.stringify(cmd));
		};
	}

	socket.onmessage = function(event){
		var data = JSON.parse(event.data);

		if(data.Command == "run"){
			if(data.Err){
				var err = data.Err;
				$("#response").css("color","red");
				$("#response").text(err);
				//alert(err);
			}else{
				var ret = data.Content;
				eval(ret);
			}
		}

		if(data.Command == "share"){
			if(data.Err){
			//alert("存在错误:\n"+data.Err);
			}else{
				var url = "{{.Host}}"+"/play/"+data.Content;
				$("#shareURL").val(url);
				$("#shareURL").select();
			}
		}

	}
	</script>
</html>
